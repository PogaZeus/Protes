<Window x:Class="Protes.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="[Protes] Pro Notes Database" 
        WindowState="Maximized"
        FontFamily="Segoe UI" 
        WindowStartupLocation="CenterScreen"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True">

    <!-- ✅ Window.Resources must remain a direct child of Window -->
    <Window.Resources>
        <ContextMenu x:Key="DataGridContextMenu" ContextMenuOpening="NotesDataGrid_ContextMenuOpening">
            <MenuItem x:Name="ContextNewNoteMenuItem" Header="_New" Click="NewNoteButton_Click">
                <MenuItem.Icon>
                    <TextBlock Text="➕" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextEditNoteMenuItem" Header="_Edit" Click="EditNoteButton_Click">
                <MenuItem.Icon>
                    <TextBlock Text="🖊️" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextCopyNoteMenuItem" Header="_Copy" Click="CopyNoteButton_Click">
                <MenuItem.Icon>
                    <TextBlock Text="📋" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextPasteNoteMenuItem" Header="_Paste" Click="PasteNoteButton_Click">
                <MenuItem.Icon>
                    <TextBlock Text="📄" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextSelectNotesMenuItem" Header="_Select" Click="SelectNotesButton_Click">
                <MenuItem.Icon>
                    <TextBlock Text="✅" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextDeleteNoteMenuItem" Header="_Delete" Click="DeleteNoteButton_Click">
                <MenuItem.Icon>
                    <TextBlock Text="🗑️" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <Separator/>
            <MenuItem x:Name="ContextImportFilesMenuItem" Header="_Import File(s)…" Click="ImportFilesMenuItem_Click">
                <MenuItem.Icon>
                    <TextBlock Text="📁" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextExportFilesMenuItem" Header="_Export File(s)…" Click="ExportFilesMenuItem_Click">
                <MenuItem.Icon>
                    <TextBlock Text="📤" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <Separator/>
            <MenuItem x:Name="ContextSwitchModeMenuItem" Header="Switch Mode">
                <MenuItem.Icon>
                    <TextBlock Text="🔄" FontSize="14"/>
                </MenuItem.Icon>
                <MenuItem x:Name="ContextLocalDbMenuItem" Header="Local Database" IsCheckable="True" Click="UseLocalDb_Click"/>
                <MenuItem x:Name="ContextExternalDbMenuItem" Header="External Database" IsCheckable="True" Click="UseExternalDb_Click"/>
            </MenuItem>
            <MenuItem x:Name="ContextSwitchLocalMenuItem" Header="Switch Local" Visibility="Collapsed"/>
            <MenuItem x:Name="ContextSwitchExternalMenuItem" Header="Switch External" Visibility="Collapsed"/>
            <Separator/>
            <MenuItem x:Name="ContextConnectMenuItem" Header="_Connect" Click="Connect_Click">
                <MenuItem.Icon>
                    <TextBlock Text="🔌" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem x:Name="ContextDisconnectMenuItem" Header="_Disconnect" Click="Disconnect_Click">
                <MenuItem.Icon>
                    <TextBlock Text="🚫" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
            <Separator/>
            <MenuItem x:Name="ContextOptionsMenuItem" Header="_Options" Click="OpenSettings_Click">
                <MenuItem.Icon>
                    <TextBlock Text="⚙️" FontSize="14"/>
                </MenuItem.Icon>
            </MenuItem>
        </ContextMenu>
    </Window.Resources>

    <!-- ✅ ROOT WRAPPER GRID: captures right-click anywhere -->
    <Grid x:Name="MainContentGrid" 
      Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Menu -->
            <RowDefinition Height="Auto"/>
            <!-- Icon Tray + Actions + Search -->
            <RowDefinition Height="*"/>
            <!-- Notes Table -->
            <RowDefinition Height="Auto"/>
            <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- === MENU BAR === -->
        <Menu Grid.Row="0" x:Name="MainMenu">
            <MenuItem Header="_File">
                <MenuItem x:Name="NewDatabaseMenuItem" Header="New _Database" Click="NewDatabaseMenuItem_Click"/>
                <MenuItem x:Name="NewNoteMenuItem" Header="_New Note" Click="NewNoteButton_Click"/>
                <MenuItem x:Name="EditNoteMenuItem" Header="_Edit" Click="EditNoteButton_Click"/>
                <MenuItem x:Name="DeleteNoteMenuItem" Header="_Delete" Click="DeleteNoteButton_Click"/>
                <Separator/>
                <MenuItem x:Name="ImportFilesMenuItem" Header="_Import File(s)…" Click="ImportFilesMenuItem_Click"/>
                <MenuItem x:Name="ExportFilesMenuItem" Header="_Export File(s)…" Click="ExportFilesMenuItem_Click"/>
                <Separator/>
                <MenuItem x:Name="ConnectMenuItem" Header="_Connect" Click="Connect_Click"/>
                <MenuItem x:Name="DisconnectMenuItem" Header="_Disconnect" Click="Disconnect_Click"/>
                <Separator/>
                <MenuItem Header="_Quit" Click="Quit_Click"/>
            </MenuItem>

            <MenuItem Header="_Options" Name="OptionsMenu">
                <MenuItem Header="Font" Click="MainWindowFontMenuItem_Click"/>
                <MenuItem x:Name="ToolbarOptionsMenu" Header="Toolbar">
                    <MenuItem x:Name="ViewToolbarConnectMenuItem" Header="Connect/Disconnect" IsCheckable="True" Checked="ViewToolbarConnectMenuItem_Checked" Unchecked="ViewToolbarConnectMenuItem_Checked"/>
                    <MenuItem x:Name="ViewToolbarACOSMenuItem" Header="AutoConnectOnSwitch" IsCheckable="True" Checked="ViewToolbarACOSMenuItem_Checked" Unchecked="ViewToolbarACOSMenuItem_Checked"/>
                    <MenuItem x:Name="ViewToolbarLocalDBMenuItem" Header="Local Databases" IsCheckable="True" Checked="ViewToolbarLocalDBMenuItem_Checked" Unchecked="ViewToolbarLocalDBMenuItem_Checked"/>
                    <MenuItem x:Name="ViewToolbarImpExMenuItem" Header="Import/Export" IsCheckable="True" Checked="ViewToolbarImpExMenuItem_Checked" Unchecked="ViewToolbarImpExMenuItem_Checked"/>
                    <MenuItem x:Name="ViewToolbarSearchMenuItem" Header="Search Database" IsCheckable="True" Checked="ViewToolbarSearchMenuItem_Checked" Unchecked="ViewToolbarSearchMenuItem_Checked"/>
                </MenuItem>
                <MenuItem Header="_Settings" Click="OpenSettings_Click"/>
            </MenuItem>

            <MenuItem Header="_Mode" Name="ModeMenu">
                <MenuItem x:Name="LocalDbMenuItem" Header="_Local Database" Click="UseLocalDb_Click" IsCheckable="True"/>
                <MenuItem x:Name="ExternalDbMenuItem" Header="_External Database" Click="UseExternalDb_Click" IsCheckable="True"/>
            </MenuItem>

            <MenuItem Header="_View">
                <MenuItem x:Name="ViewTitleMenuItem" Header="Title" IsCheckable="True" Checked="ViewTitleMenuItem_Checked" Unchecked="ViewTitleMenuItem_Checked"/>
                <MenuItem x:Name="ViewTagsMenuItem" Header="Tags" IsCheckable="True" Checked="ViewTagsMenuItem_Checked" Unchecked="ViewTagsMenuItem_Checked"/>
                <MenuItem x:Name="ViewModifiedMenuItem" Header="Modified" IsCheckable="True" Checked="ViewModifiedMenuItem_Checked" Unchecked="ViewModifiedMenuItem_Checked"/>
                <Separator/>
                <MenuItem Header="_Zoom">
                    <MenuItem Header="Zoom _In" Click="ZoomInMenuItem_Click" InputGestureText="Ctrl+Plus"/>
                    <MenuItem Header="Zoom _Out" Click="ZoomOutMenuItem_Click" InputGestureText="Ctrl+Minus"/>
                    <MenuItem Header="_Restore Zoom" Click="RestoreZoomMenuItem_Click" InputGestureText="Ctrl+0"/>
                </MenuItem>
                <Separator/>
                <MenuItem x:Name="ViewToolbarMenuItem" Header="Toolbar" IsCheckable="True" Checked="ViewToolbarMenuItem_Checked" Unchecked="ViewToolbarMenuItem_Checked"/>
            </MenuItem>

            <MenuItem Header="_Info">
                <MenuItem Header="_About" Click="AboutMenuItem_Click"/>
            </MenuItem>
        </Menu>

        <!-- === ICON TRAY + NOTE ACTIONS + SEARCH === -->
        <StackPanel x:Name="ToolbarStackPanel" Grid.Row="1" Orientation="Horizontal" Margin="5,5"
            HorizontalAlignment="Left" VerticalAlignment="Top">
            <StackPanel x:Name="ViewToolbarConnectainer" Orientation="Horizontal" VerticalAlignment="Center">
                <Button x:Name="ConnectIconBtn" Content="🔌" FontSize="16" Width="32" Height="32"
                    ToolTip="Connect" Click="Connect_Click" Margin="0,0,8,0"/>
                <Button x:Name="DisconnectIconBtn" Content="🚫" FontSize="16" Width="32" Height="32"
                    ToolTip="Disconnect" Click="Disconnect_Click" Margin="0,0,8,0"/>
            </StackPanel>

            <Border x:Name="AutoConnectOSContainer">
                <CheckBox x:Name="AutoConnectOnSwitchCheckBox" x:Uid="AutoConnectOnSwitchCheckBox"
                    Content="ACOS" 
                    VerticalAlignment="Center"
                    Checked="AutoConnectOnSwitchCheckBox_Checked"
                    Unchecked="AutoConnectOnSwitchCheckBox_Checked" Margin="0,0,8,0"/>
            </Border>

            <Rectangle Fill="Gray" Width="1" Height="24" Margin="0,0,8,0" Opacity="0.6"/>

            <Button x:Name="SettingsIconBtn" Content="⚙️" FontSize="16" Width="32" Height="32"
                ToolTip="Settings" Click="OpenSettings_Click" Margin="0,0,8,0"/>

            <StackPanel x:Name="LocalDbControls" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock x:Name="DatabaseModeLabel" Text="Local:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <ComboBox x:Name="DatabaseOrConnectionComboBox" MinWidth="150" Margin="0,0,8,0" VerticalContentAlignment="Center" Height="28"/>
                <Button x:Name="LoadSelectedDbButton" Content="↻" FontSize="16" Width="32" Height="32"
            ToolTip="Load Selected Database or Connection" Click="LoadSelectedDbButton_Click" Margin="0,0,8,0"/>
            </StackPanel>
            <Rectangle Fill="Gray" Width="1" Height="24" Margin="0,0,8,0" Opacity="0.6"/>
            <StackPanel x:Name="ImportExportControls" Orientation="Horizontal" VerticalAlignment="Center">
                <Button x:Name="ImportFilesButton" Content="📁" Padding="6,5"
                    FontSize="16" Click="ImportFilesMenuItem_Click" Margin="0,0,8,0" ToolTip="Import Files"/>
                <Button x:Name="ExportFilesButton" Content="📤" Padding="6,5"
                    FontSize="16" Click="ExportFilesMenuItem_Click" Margin="0,0,8,0" ToolTip="Export Files"/>
                <Rectangle Fill="Gray" Width="1" Height="24" Margin="0,0,8,0" Opacity="0.6"/>
            </StackPanel>

            <Button x:Name="NewNoteButton" Content="➕" Padding="6,5"
                FontSize="16" Click="NewNoteButton_Click" Margin="0,0,8,0" ToolTip="New"/>
            <Button x:Name="EditNoteButton" Content="🖊️" Padding="6,5"
                FontSize="16" Click="EditNoteButton_Click" Margin="0,0,8,0" ToolTip="Edit"/>
            <Button x:Name="SelectNotesButton" Content="✅" Padding="6,5"
                FontSize="16" Click="SelectNotesButton_Click" Margin="0,0,8,0" ToolTip="Select"/>
            <Button x:Name="DeleteNoteButton" Content="🗑️" Padding="6,5"
                FontSize="16" Click="DeleteNoteButton_Click" Margin="0,0,8,0" ToolTip="Delete"/>
            <Rectangle Fill="Gray" Width="1" Height="24" Margin="0,0,8,0" Opacity="0.6"/>

            <Button x:Name="CopyNoteButton" Content="📋" Padding="6,5"
                FontSize="16" Click="CopyNoteButton_Click" Margin="0,0,8,0" ToolTip="Copy Note(s)"/>
            <Button x:Name="PasteNoteButton" Content="📄" Padding="6,5"
                FontSize="16" Click="PasteNoteButton_Click" Margin="0,0,8,0" ToolTip="Paste Note(s)"/>

            <StackPanel x:Name="SearchDatabase" Orientation="Horizontal" VerticalAlignment="Center">
                <Rectangle Fill="Gray" Width="1" Height="24" Margin="0,0,8,0" Opacity="0.6"/>
                <TextBlock Text="Search:" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,0,8,0"/>
                <ComboBox x:Name="SearchFieldComboBox" SelectedIndex="0" Height="28" Width="100" VerticalContentAlignment="Center" Margin="0,0,8,0">
                    <ComboBoxItem Content="All"/>
                    <ComboBoxItem Content="Title"/>
                    <ComboBoxItem Content="Content"/>
                    <ComboBoxItem Content="Tags"/>
                    <ComboBoxItem Content="Modified"/>
                </ComboBox>
                <TextBox x:Name="SearchBox" Width="200" Height="28"
                    VerticalContentAlignment="Center"
                    TextChanged="SearchBox_TextChanged"
                    VerticalAlignment="Center" Margin="0,0,8,0"/>
            </StackPanel>
            <Button x:Name="CatButton" Content="🐾" FontSize="16" Padding="6,5" Margin="0,0,8,0" ToolTip="Open Cat Wisdom" Click="OpenCatWindow_Click"/>
        </StackPanel>

        <!-- === NOTES TABLE (DATA GRID) === -->
        <DataGrid Grid.Row="2" x:Name="NotesDataGrid"
                  FontSize="11"
                  ContextMenuOpening="NotesDataGrid_ContextMenuOpening"
                  PreviewMouseDown="NotesDataGrid_PreviewMouseDown" 
                  VerticalScrollBarVisibility="Auto"
                  Margin="5"
                  AutoGenerateColumns="False"
                  IsReadOnly="False"    
                  CanUserAddRows="False" 
                  SelectionMode="Extended"
                  SelectionUnit="FullRow"
                  Visibility="Collapsed"
                  ScrollViewer.CanContentScroll="True"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  BeginningEdit="NotesDataGrid_BeginningEdit"
                  CellEditEnding="NotesDataGrid_CellEditEnding"
                  MouseDoubleClick="NotesDataGrid_MouseDoubleClick">
            <DataGrid.Resources>
                <Style TargetType="ScrollBar">
                    <Setter Property="IsHitTestVisible" Value="True"/>
                    <Setter Property="Focusable" Value="True"/>
                </Style>
            </DataGrid.Resources>
            <DataGrid.Columns>
                <DataGridTemplateColumn 
                    x:Name="SelectCheckBoxColumn"
                    Width="40"
                    CanUserResize="False"
                    Visibility="Collapsed">
                    <DataGridTemplateColumn.HeaderTemplate>
                        <DataTemplate>
                            <CheckBox 
                                IsChecked="{Binding RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}, Path=DataContext.AllItemsAreChecked, Mode=TwoWay}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Margin="6,0"
                                Focusable="True"
                                IsHitTestVisible="True" />
                        </DataTemplate>
                    </DataGridTemplateColumn.HeaderTemplate>
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <CheckBox IsChecked="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="Title" Binding="{Binding Title, UpdateSourceTrigger=PropertyChanged}" Width="1*"/>
                <DataGridTextColumn Header="Preview" Binding="{Binding Preview}" IsReadOnly="True" Width="3*">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="VerticalAlignment" Value="Top"/>
                            <Setter Property="ToolTip" Value="{Binding Preview}"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
                <DataGridTextColumn Header="Tags" Binding="{Binding Tags, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                <DataGridTextColumn Header="Modified" Binding="{Binding LastModified}" IsReadOnly="True" Width="120"/>
            </DataGrid.Columns>
            <DataGrid.Template>
                <ControlTemplate TargetType="DataGrid">
                    <Border BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                        <ScrollViewer x:Name="DG_ScrollViewer" Focusable="false" Background="{TemplateBinding Background}">
                            <ItemsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                        </ScrollViewer>
                    </Border>
                </ControlTemplate>
            </DataGrid.Template>
            
        </DataGrid>

        <!-- Placeholder when disconnected -->
        <TextBlock Grid.Row="2" x:Name="DisconnectedPlaceholder"
           Text="Not connected to a database. Choose 'Local' or 'External Database' from Options."
           HorizontalAlignment="Center" VerticalAlignment="Center"
           FontSize="16" Foreground="Gray" TextWrapping="Wrap" Margin="20"/>

        <!-- === STATUS BAR === -->
        <StatusBar Grid.Row="3">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="ConnectionStatusText" Text="Disconnected"/>
                <Separator Grid.Column="1" Style="{StaticResource {x:Static StatusBar.SeparatorStyleKey}}" Margin="8,0"/>
                <TextBlock x:Name="DatabaseModeText" Grid.Column="2" Text="—"/>
                <Separator Grid.Column="3" Style="{StaticResource {x:Static StatusBar.SeparatorStyleKey}}" Margin="8,0"/>
                <TextBlock x:Name="DatabaseSwitchText" Grid.Column="4" Text="—"/>
                <Separator Grid.Column="5" Style="{StaticResource {x:Static StatusBar.SeparatorStyleKey}}" Margin="8,0,8,0"/>
                <Grid Grid.Column="6"/>
                <TextBlock x:Name="NoteCountText" Grid.Column="7" Text="0 Notes"/>
                <Separator Grid.Column="8" Style="{StaticResource {x:Static StatusBar.SeparatorStyleKey}}" Margin="8,0"/>
                <TextBlock Grid.Column="9" Text="" Visibility="Hidden"/>
            </Grid>
        </StatusBar>
    </Grid>
</Window>